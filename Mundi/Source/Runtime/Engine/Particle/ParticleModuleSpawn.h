#pragma once

#include "UParticleModuleSpawn.generated.h"
#include "Statistics.h"
#include "Vector.h"

// ============================================================================
// FParticleBurst - 버스트 스폰 정보
// ============================================================================
// 특정 시간에 한 번에 많은 파티클을 생성하는 "버스트"를 정의합니다.
//
// 사용 예시:
// - 폭발 효과: 0초에 100개 파티클을 한 번에 생성
// - 불꽃놀이: 여러 시점에 다양한 양의 파티클 생성
// ============================================================================
struct FParticleBurst
{
    // ------------------------------------------------------------------------
    // Count (버스트 개수)
    // ------------------------------------------------------------------------
    // 버스트 시 생성할 파티클 개수입니다.
    // CountLow가 -1이 아니면, CountLow~Count 범위에서 랜덤 선택됩니다.
    // ------------------------------------------------------------------------
    int32 Count = 10;

    // ------------------------------------------------------------------------
    // CountLow (랜덤 범위 최소값)
    // ------------------------------------------------------------------------
    // -1: Count 값을 고정으로 사용
    // 0 이상: CountLow~Count 범위에서 랜덤 선택
    //
    // 예시:
    // - CountLow=-1, Count=10 → 항상 10개
    // - CountLow=5, Count=15 → 5~15개 랜덤
    // ------------------------------------------------------------------------
    int32 CountLow = -1;

    // ------------------------------------------------------------------------
    // Time (버스트 발생 시간)
    // ------------------------------------------------------------------------
    // 이미터 수명 대비 비율 (0.0 ~ 1.0)
    //
    // 예시 (EmitterDuration = 5초):
    // - Time=0.0 → 0초에 발생
    // - Time=0.5 → 2.5초에 발생
    // - Time=1.0 → 5초에 발생
    // ------------------------------------------------------------------------
    float Time = 0.0f;

    FParticleBurst() = default;
    FParticleBurst(int32 InCount, float InTime)
        : Count(InCount), CountLow(-1), Time(InTime) {}
    FParticleBurst(int32 InCountLow, int32 InCount, float InTime)
        : Count(InCount), CountLow(InCountLow), Time(InTime) {}
};

// ============================================================================
// UParticleModuleSpawn
// ============================================================================
// 파티클의 스폰율과 버스트를 제어하는 모듈입니다.
//
// 언리얼 엔진의 UParticleModuleSpawn을 참고하여 구현되었습니다.
//
// 스폰 방식:
// 1. Rate 기반: 초당 일정 개수의 파티클을 연속적으로 생성
// 2. Burst 기반: 특정 시간에 한 번에 많은 파티클을 생성
//
// 스폰 개수 계산:
// SpawnRate = Rate * RateScale
// NewLeftover = OldLeftover + DeltaTime * SpawnRate
// SpawnCount = Floor(NewLeftover)
// ============================================================================
UCLASS(DisplayName="파티클 모듈 스폰", Description="파티클의 스폰율과 버스트를 제어합니다.")
class UParticleModuleSpawn : public UParticleModule
{
public:
    UParticleModuleSpawn();
    ~UParticleModuleSpawn() = default;

    GENERATED_REFLECTION_BODY()

    // ========================================================================
    // 스폰 개수 계산 함수
    // ========================================================================

    // ------------------------------------------------------------------------
    // GetSpawnAmount
    // ------------------------------------------------------------------------
    // 이번 프레임에 스폰할 파티클 개수를 계산합니다.
    //
    // 파라미터:
    // - EmitterTime: 현재 이미터 시간
    // - OldLeftover: 이전 프레임의 소수부 나머지
    // - DeltaTime: 프레임 경과 시간
    // - OutNumber: [출력] 스폰할 파티클 개수
    // - OutNewLeftover: [출력] 다음 프레임으로 이월할 소수부
    //
    // 반환: 스폰율 (초당 파티클 개수)
    // ------------------------------------------------------------------------
    float GetSpawnAmount(float EmitterTime, float OldLeftover, float DeltaTime,
                         int32& OutNumber, float& OutNewLeftover);

    // ------------------------------------------------------------------------
    // GetBurstCount
    // ------------------------------------------------------------------------
    // 이번 프레임에 버스트로 생성할 파티클 개수를 계산합니다.
    //
    // 파라미터:
    // - EmitterTime: 현재 이미터 시간
    // - EmitterDuration: 이미터 전체 지속 시간
    // - BurstFired: [입출력] 각 버스트의 발사 여부
    //
    // 반환: 버스트로 생성할 파티클 총 개수
    // ------------------------------------------------------------------------
    int32 GetBurstCount(float EmitterTime, float EmitterDuration, TArray<bool>& BurstFired);

    // ========================================================================
    // Getters
    // ========================================================================
    const FRawDistribution<float>& GetRate() const;
    const FRawDistribution<float>& GetRateScale() const;
    const TArray<FParticleBurst>& GetBurstList() const;
    float GetMaxSpawnRate() const;

    // ========================================================================
    // Setters
    // ========================================================================
    void SetRate(const FRawDistribution<float>& InRate);
    void SetRateMin(float InMin);
    void SetRateMax(float InMax);
    void SetRateScale(const FRawDistribution<float>& InScale);
    void SetRateScaleMin(float InMin);
    void SetRateScaleMax(float InMax);

    // ========================================================================
    // 버스트 관리 함수
    // ========================================================================
    void AddBurst(const FParticleBurst& Burst);
    void AddBurst(int32 Count, float Time);
    void AddBurst(int32 CountLow, int32 Count, float Time);
    void ClearBursts();
    int32 GetBurstCount() const;

private:
    // ========================================================================
    // 스폰율 관련 프로퍼티
    // ========================================================================

    // ------------------------------------------------------------------------
    // Rate (기본 스폰율)
    // ------------------------------------------------------------------------
    // 초당 생성할 파티클 개수입니다.
    //
    // Distribution의 Mode에 따라:
    // - Uniform 모드: Min~Max 사이에서 랜덤 스폰율
    // - Curve 모드: EmitterTime에 따라 스폰율이 변화
    //
    // 기본값: 20.0 (초당 20개)
    //
    // 예시:
    // - 약한 연기: Rate = 5~10
    // - 강한 화염: Rate = 50~100
    // ------------------------------------------------------------------------
    UPROPERTY(EditAnywhere, Category="[스폰]", Tooltip="초당 생성할 파티클 개수")
    FRawDistribution<float> Rate{};

    // ------------------------------------------------------------------------
    // RateScale (스폰율 배율)
    // ------------------------------------------------------------------------
    // Rate에 곱해지는 배율입니다.
    //
    // 최종 스폰율 = Rate * RateScale
    //
    // 용도:
    // - 시간에 따른 스폰율 감소/증가
    // - 게임플레이에 따른 동적 조절
    //
    // 기본값: 1.0 (100%)
    // ------------------------------------------------------------------------
    UPROPERTY(EditAnywhere, Category="[스폰]", Tooltip="스폰율에 곱해지는 배율")
    FRawDistribution<float> RateScale{};

    // ========================================================================
    // 버스트 관련 프로퍼티
    // ========================================================================

    // ------------------------------------------------------------------------
    // BurstList (버스트 목록)
    // ------------------------------------------------------------------------
    // 특정 시간에 한 번에 생성할 파티클 정보 목록입니다.
    //
    // 각 버스트는 한 번만 발생합니다.
    // (루프 이미터의 경우 루프마다 다시 발생)
    //
    // 예시 (5초 이미터):
    // - {Count=50, Time=0.0} → 0초에 50개
    // - {Count=30, Time=0.5} → 2.5초에 30개
    // - {Count=20, Time=1.0} → 5초에 20개
    // ------------------------------------------------------------------------
    UPROPERTY(EditAnywhere, Category="[버스트a]", Tooltip="버스트 스폰 목록")
    TArray<FParticleBurst> BurstList{};
};
